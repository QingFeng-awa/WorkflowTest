name: Trigger API on Push

on:
  push:
    branches: [ main ]

env:
  PANEL_TOKEN: ${{ secrets.PANEL_TOKEN }}

jobs:
  call-api:
    runs-on: ubuntu-latest
    steps:
      - name: Get current timestamp
        id: timestamp
        run: echo "CURRENT_TIMESTAMP=$(date +%s)" >> $GITHUB_ENV

      - name: Call API and verify response
        run: |
          response=$(curl -s -v -X 'POST' \
            'http://panel.qingfengawa.top:11451/api/v1/cronjobs/handle' \
            -H 'accept: application/json' \
            -H 'Content-Type: application/json' \
            -H "1Panel-Token: ${{ env.PANEL_TOKEN }}" \
            -H "1Panel-Timestamp: ${{ env.CURRENT_TIMESTAMP }}" \
            -d '{"id": 10}' 2>&1)

          echo "Raw API response: $response"

          if ! echo "$response" | grep -q "HTTP/.* 200"; then
            echo "API request failed"
            echo "$response"
            exit 1
          fi
          
          json_response=$(echo "$response" | awk '/^{/,0')

          if ! jq -e . <<< "$json_response" >/dev/null 2>&1; then
            echo "Invalid JSON response: $json_response"
            exit 1
          fi

          code=$(echo "$json_response" | jq -r '.code')
          if [ "$code" != "200" ]; then
            echo "API returned non-200 code: $code"
            echo "Full response: $json_response"
            exit 1
          fi

          echo "API call succeeded"
